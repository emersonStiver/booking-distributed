version: "3.9"

services:
  # ------------------------------
  # MySQL for RESERVAS
  # ------------------------------
  mysql_reservas:
    image: mysql:8.0
    container_name: mysql_reservas
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: reservas_db
    ports:
      - "3307:3306"
    volumes:
      - reservas_data:/var/lib/mysql
    networks:
      - backend

  # ------------------------------
  # MySQL for USUARIOS
  # ------------------------------
  mysql_usuarios:
    image: mysql:8.0
    container_name: mysql_usuarios
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: usuarios_db
    ports:
      - "3308:3306"
    volumes:
      - usuarios_data:/var/lib/mysql
    networks:
      - backend

  # ------------------------------
  # RESERVAS Service
  # ------------------------------
  reservas-service:
    build: ./reserves
    container_name: reservas-service
    depends_on:
      - mysql_reservas
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql_reservas:3306/reservas_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
    ports:
      - "8081:8081"
    networks:
      - backend

  # ------------------------------
  # USUARIOS Service
  # ------------------------------
  usuarios-service:
    build: ./user
    container_name: usuarios-service
    depends_on:
      - mysql_usuarios
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql_usuarios:3306/usuarios_db
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
    ports:
      - "8082:8082"
    networks:
      - backend

  # ------------------------------
  # API Gateway
  # ------------------------------
  api-gateway:
    build: ./gateway
    container_name: api-gateway
    depends_on:
      - reservas-service
      - usuarios-service
    ports:
      - "8083:8083"
    networks:
      - backend

  # ------------------------------
  # Angular Frontend
  # ------------------------------
  frontend:
    build:
      context: ./booking-angular
      dockerfile: Dockerfile
    container_name: reservas-frontend
    ports:
      - "4200:80"
    depends_on:
      - api-gateway
    networks:
      - backend

networks:
  backend:

volumes:
  reservas_data:
  usuarios_data:
